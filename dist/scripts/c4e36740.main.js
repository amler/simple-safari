"use strict";function Map(a){this.markers=[],this.images=["images/map-markers/user.png","images/map-markers/pin.png","images/map-markers/flag.png"];var b=new google.maps.LatLng(34.853738,-82.395618),c={zoom:13,center:b};this.map=new google.maps.Map(document.getElementById(a),c),this.addMarker(0,34.853738,-82.395618)}function changeLayout(a,b){menu.hide(),views.loading.render(),map.deleteAllMarkers(),userGeo.clearWatchLocation(),a===!0?($("header .button").show(),$("header button").hide()):($("header button").show(),$("header .button").hide()),b===!0?$("#map-container").show():$("#map-container").hide()}Map.prototype.addMarker=function(a,b,c){var d=new google.maps.LatLng(b,c),e=new google.maps.Marker({position:d,map:this.map,animation:google.maps.Animation.DROP,icon:{url:this.images[a],size:new google.maps.Size(50,50),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(25,50),scaledSize:new google.maps.Size(50,50)}});return this.markers.push(e),e},Map.prototype.showAllMarkers=function(){for(var a=0;a<this.markers.length;a++)this.markers[a].setMap(this.map)},Map.prototype.hideAllMarkers=function(){for(var a=0;a<this.markers.length;a++)this.markers[a].setMap(null)},Map.prototype.deleteMarker=function(a){this.markers[a].setMap(null),this.markers.splice(a,1)},Map.prototype.deleteAllMarkers=function(){this.hideAllMarkers(),this.markers=[],this.addMarker(0,34.853738,-82.395618)},Map.prototype.updateMarkerPosition=function(a,b,c){var d=new google.maps.LatLng(b,c);this.markers[a].setPosition(d)},Map.prototype.centerMapAtPosition=function(a,b){var c=new google.maps.LatLng(a,b);this.map.panTo(c)},Map.prototype.zoomMapToFitAllMarkers=function(){for(var a=new google.maps.LatLngBounds,b=0;b<this.markers.length;b++)a.extend(this.markers[b].getPosition());this.map.fitBounds(a)};var menu={init:function(){var a=this;$("body").on("click",".toggle-menu",function(){a.toggle()})},kill:function(){$("body").off("click",".toggle-menu")},show:function(){$("body").addClass("show-menu")},hide:function(){$("body").removeClass("show-menu")},toggle:function(){$("body").toggleClass("show-menu")}},userGeo={latitude:"",longitude:"",watchID:0,findLocation:function(){if(""===this.latitude&&""===this.longitude){var a=this;if(!navigator.geolocation)return void alert("Geolocation is not supported by your browser");navigator.geolocation.getCurrentPosition(function(b){a.latitude=b.coords.latitude,a.longitude=b.coords.longitude,window.map.updateMarkerPosition(0,b.coords.latitude,b.coords.longitude),window.map.centerMapAtPosition(b.coords.latitude,b.coords.longitude),$("#view h2").trigger("userGeoLocated")})}else $("#view h2").trigger("userGeoLocated")},watchLocation:function(){var a=this;return navigator.geolocation?void navigator.geolocation.watchPosition(function(b){a.latitude=b.coords.latitude,a.longitude=b.coords.longitude,window.map.updateMarkerPosition(0,b.coords.latitude,b.coords.longitude),window.map.centerMapAtPosition(b.coords.latitude,b.coords.longitude),$("#view h2").trigger("userGeoWatched")}):void alert("Geolocation is not supported by your browser")},clearWatchLocation:function(){navigator.geolocation.clearWatch(this.watchID)}},helper={getDistance:function(a,b,c,d){var e=new LatLon(a,b),f=new LatLon(c,d),g=e.distanceTo(f);return.621371*g}},Location=Parse.Object.extend({className:"Location"}),LocationsCollection=Parse.Collection.extend({model:Location}),ScavengerHunt=Parse.Object.extend({className:"ScavengerHunt"}),ScavengerHuntsCollection=Parse.Collection.extend({model:ScavengerHunt}),Photo=Parse.Object.extend({className:"Photo"}),PhotoCollection=Parse.Collection.extend({model:Photo}),DashboardView=Parse.View.extend({el:"#view",template:_.template($("#dashboard-view-template").text()),sectionName:"",events:{"userGeoLocated h2":"queryLocations"},render:function(){return this.$el.html(this.template),this.sectionName=this.$el.find("h2").text(),this},queryLocations:function(a){if($(a.currentTarget).text()===this.sectionName){var b=new Parse.GeoPoint({latitude:userGeo.latitude,longitude:userGeo.longitude}),c=new Parse.Query(ScavengerHunt);c.withinMiles("geolocation",b,30),c.find({success:function(a){var b=_.template($("#hunt-item-template").text());a.forEach(function(a){var c=b(a);$(".nearby-safaris").append(c),map.addMarker(1,a.attributes.geolocation._latitude,a.attributes.geolocation._longitude),map.zoomMapToFitAllMarkers()})},error:function(a){alert("DashboardView Error: "+a.code+" "+a.message)}})}}}),DiscoverView=Parse.View.extend({el:"#view",template:_.template($("#discover-view-template").text()),sectionName:"",locations:[],events:{"userGeoLocated h2":"userLocated","userGeoWatched h2":"userWatched","change .photo":"photoCaptured"},render:function(){return this.$el.html(this.template),this.sectionName=this.$el.find("h2").text(),this.queryUsersHunts(),this},queryUsersHunts:function(){var a=this,b=Parse.User.current(),c=b.relation("scavengerHunts"),d=c.query();d.find({success:function(b){a.queryUsersLocations(b)},error:function(){alert("There was a problem finding your safaris.")}})},queryUsersLocations:function(a){var b=0;this.locations=[];var c=this;a.forEach(function(d){var e=d.relation("locations"),f=e.query();f.find({success:function(d){c.locations.push.apply(c.locations,d),b++,b>=a.length&&c.addLocationsToMap()},error:function(a){console.log("There was an error: ",a)}})})},addLocationsToMap:function(){this.locations.forEach(function(a){map.addMarker(1,a.attributes.geolocation._latitude,a.attributes.geolocation._longitude)}),userGeo.findLocation()},userLocated:function(a){$(a.currentTarget).text()===this.sectionName&&(this.userLocationUpdated(),userGeo.watchLocation())},userWatched:function(a){$(a.currentTarget).text()===this.sectionName&&this.userLocationUpdated()},userLocationUpdated:function(){var a=_.template($("#location-item-template").text());$(".nearby-safaris").empty(),this.locations.forEach(function(b){var c=helper.getDistance(userGeo.latitude,userGeo.longitude,b.attributes.geolocation._latitude,b.attributes.geolocation._longitude);if(.05>=c){var d=a(b);$(".nearby-safaris").append(d)}})},photoCaptured:function(a){var b=$(a.currentTarget).data("object-id"),c=$(a.currentTarget)[0];if(c.files.length>0){views.loading.render();var d=c.files[0],e="photo.png",f=new Parse.File(e,d);f.save().then(function(){var a=Parse.User.current(),c=new Photo,d=new Parse.GeoPoint({latitude:userGeo.latitude,longitude:userGeo.longitude}),e=new Location;e.id=b,c.set("geolocation",d),c.set("location",e),c.set("photo",f),c.set("user",a),c.set("photoURL",f.url()),c.save().done(function(){window.router.navigate("photo/"+c.id,{trigger:!0})})},function(){alert("Failed to save photo"),views.discover.render()})}}}),ForgotPasswordView=Parse.View.extend({el:"#view",template:_.template($("#forgotpassword-view-template").text()),events:{"click .forgot-password-button":"password"},render:function(){return this.$el.html(this.template),this},password:function(a){a.preventDefault();var b=$(".enter-email").val();Parse.User.requestPasswordReset(b,{success:function(){alert("An email has been sent. Please be sure to check your spam folder!"),window.router.navigate("login",{trigger:!0})},error:function(){alert("There was a problem processing your request.")}})}}),LoadingView=Parse.View.extend({el:"#view",template:_.template($("#loading-view-template").text()),render:function(){return this.$el.html(this.template),this}}),LocationDetailView=Parse.View.extend({el:"#view",template:_.template($("#detail-location-template").text()),sectionName:"",events:{"userGeoLocated h2":"queryLocations"},selectedLocation:"",render:function(){return this.$el.html(this.template),this.sectionName=this.$el.find("h2").text(),this},queryLocations:function(a){$(a.currentTarget).text()===this.sectionName&&console.log(userGeo.latitude,userGeo.longitude)},subscribedPhoto:function(a){var b=this,c=new Parse.Query(Location);c.equalTo("objectId",a),c.find({success:function(a){a.forEach(function(a){b.selectedLocation=a,b.queryLocationPhotos(),b.render(),map.addMarker(1,a.attributes.geolocation._latitude,a.attributes.geolocation._longitude),map.zoomMapToFitAllMarkers()})},error:function(a){console.log("Error: "+a.code+" "+a.message)}})},queryLocationPhotos:function(){var a=this.selectedLocation,b=Parse.Object.extend("Photo"),c=new Parse.Query(b);c.equalTo("location",a),c.find({success:function(a){console.log("this is a success: ",a);var b=_.template($("#location-photolist-template").text());a.forEach(function(a){var c=b(a);$(".subscribed-photolist").append(c)})},error:function(a){console.log(a)}})}}),LoginView=Parse.View.extend({el:"#view",template:_.template($("#login-view-template").text()),events:{"click .login-button":"login"},render:function(){return this.$el.html(this.template),this},login:function(a){a.preventDefault();var b=$(".login-username").val(),c=$(".login-password").val();$(".login-username").removeClass("input-error"),$(".login-password").removeClass("input-error"),$(".login-username").val()?$(".login-password").val()?Parse.User.logIn(b,c,{ACL:new Parse.ACL,success:function(){{var a=Parse.User.current();Parse.User.current()._sessionToken}a?(Parse.User.become(a._sessionToken).then(function(){}),window.router.navigate("",{trigger:!0})):alert("There was an error with your login")},error:function(){alert("login does not work")}}):$(".login-password").addClass("input-error"):$(".login-username").addClass("input-error")}}),HomeView=Parse.View.extend({el:"#view",template:_.template($("#home-view-template").text()),render:function(){return this.$el.html(this.template),this}}),PhotoDetailView=Parse.View.extend({el:"#view",template:_.template($("#photodetail-view-template").text()),render:function(a){var b=this.template(a);return this.$el.html(b),this},findPhoto:function(a){var b=this,c=Parse.Object.extend("Photo"),d=new Parse.Query(c);d.get(a,{success:function(a){b.render(a),b.findPhotoLocation(a)},error:function(){alert("There was an error retrieving your photo")}})},findPhotoLocation:function(a){var b=a.get("location");b.fetch({success:function(a){var b=_.template($("#fetched-location-template").text()),c=b(a);$(".photodetail-location-name").append(c),map.deleteMarker(0),map.addMarker(1,a.attributes.geolocation._latitude,a.attributes.geolocation._longitude),map.zoomMapToFitAllMarkers()},error:function(){alert("There was an error getting the location of your photo.")}})}}),SafarisView=Parse.View.extend({el:"#view",template:_.template($("#safaris-view-template").text()),events:{"click .unsubscribe-safari-view":"retrieveHunt"},selectedHunt:"",render:function(){return this.$el.html(this.template),this.sectionName=this.$el.find("h2").text(),this.queryUserScavengerHunts(),this},queryUserScavengerHunts:function(){var a=Parse.User.current(),b=a.relation("scavengerHunts"),c=b.query();c.find({success:function(a){var b=_.template($("#safaris-listing-template").text());a.forEach(function(a){var c=b(a);$(".users-scavengerhunt-list").append(c)})},error:function(a){alert("User ScavengerHunt error: ",a)}})},retrieveHunt:function(a){var b=this,c=$(a.currentTarget).data("object-id"),d=new Parse.Query(ScavengerHunt);d.equalTo("objectId",c),d.find({success:function(a){a.forEach(function(a){b.selectedHunt=a,b.unsubscribe()})},error:function(a){alert("SafarisView Error: "+a.code+" "+a.message)}})},unsubscribe:function(){var a=Parse.User.current(),b=a.relation("scavengerHunts");b.remove(this.selectedHunt),a.save(),this.render()}}),SafariDetailView=Parse.View.extend({el:"#view",template:_.template($("#safaridetail-view-template").text()),sectionName:"",events:{"userGeoLocated h2":"queryLocations","click .subscribe-scavengerhunt":"subscribeToHunt","click .unsubscribe-scavengerhunt":"unsubscribeFromHunt"},scavengerHuntModel:"",render:function(a){this.scavengerHuntModel=a;var b=this.template(a);this.$el.html(b),this.sectionName=this.$el.find("h2").text();var c=this,d=Parse.User.current(),e=d.relation("scavengerHunts"),f=e.query();return f.equalTo("objectId",this.scavengerHuntModel.id),f.find({success:function(a){c.findLocationsForScavengerHunt(),a.length>0?$(".unsubscribe-scavengerhunt").show():$(".subscribe-scavengerhunt").show()},error:function(){alert("There was an error determining if you are subscribed to this safari.")}}),this},queryLocations:function(a){$(a.currentTarget).text()===this.sectionName&&console.log(userGeo.latitude,userGeo.longitude)},subscribeToHunt:function(a){$(".subscribe-scavengerhunt").hide(),a.preventDefault();var b=Parse.User.current(),c=b.relation("scavengerHunts");c.add(this.scavengerHuntModel),b.save(),$(".unsubscribe-scavengerhunt").show()},unsubscribeFromHunt:function(a){$(".unsubscribe-scavengerhunt").hide(),a.preventDefault();var b=Parse.User.current(),c=b.relation("scavengerHunts");c.remove(this.scavengerHuntModel),b.save(),$(".subscribe-scavengerhunt").show()},findLocationsForScavengerHunt:function(){var a=this.scavengerHuntModel.relation("locations"),b=a.query(),c=new Parse.GeoPoint({latitude:userGeo.latitude,longitude:userGeo.longitude});b.withinMiles("geolocation",c,30),b.find({success:function(a){var b=_.template($("#location-listing-template").text());a.forEach(function(a){var c=b(a);$(".selected-safari-locations").append(c),map.addMarker(1,a.attributes.geolocation._latitude,a.attributes.geolocation._longitude)})},error:function(){alert("error on rendering locations")}})}}),SignUpView=Parse.View.extend({el:"#view",template:_.template($("#signup-view-template").text()),events:{"click .signup-button":"signup"},render:function(){return this.$el.html(this.template),this},signup:function(a){a.preventDefault();var b=$(".signup-username").val(),c=$(".signup-password").val(),d=$(".signup-email").val();if($(".signup-username").removeClass("input-error"),$(".signup-password").removeClass("input-error"),$(".signup-email").removeClass("input-error"),$(".signup-username").val())if($(".signup-password").val())if($(".signup-email").val()){var e=new Parse.User;e.set("username",b),e.set("password",c),e.set("email",d),e.signUp(null,{success:function(){var a=Parse.User.current();a?window.router.navigate("",{trigger:!0}):alert("There was an error processing your information.")},error:function(){alert("There was an error processing your information.")}})}else $(".signup-email").addClass("input-error");else $(".signup-password").addClass("input-error");else $(".signup-username").addClass("input-error")}}),UserPhotosView=Parse.View.extend({el:"#view",template:_.template($("#userphotos-view-template").text()),render:function(){return this.$el.html(this.template),this.findUserPhotos(),this},findUserPhotos:function(){var a=_.template($("#userimage-thumbnail-template").text()),b=Parse.User.current(),c=Parse.Object.extend("Photo"),d=new Parse.Query(c);d.equalTo("user",b),d.find({success:function(b){b.forEach(function(b){var c=a(b);$(".users-images").append(c)})},error:function(a){alert("UserPhotosView Error: "+a.code+" "+a.message)}})}});Parse.initialize("tST7HFW9NWFhy9y9fan8kOYqFEy5TVFyV32XV3zk","xBNOXQU66455p4QokthOKO8ZLDx5oo0ACV52xuBg");var map=new Map("map-container");menu.init();var collections={scavengerHunts:new ScavengerHuntsCollection,locations:new LocationsCollection},models={scavengerHunt:new ScavengerHunt,huntLocation:new Location,photo:new Photo},views={dashboard:new DashboardView,discover:new DiscoverView,forgotPassword:new ForgotPasswordView,home:new HomeView,loading:new LoadingView,locationDetail:new LocationDetailView,login:new LoginView,photoDetail:new PhotoDetailView,userPhoto:new UserPhotosView,safaris:new SafarisView,safariDetail:new SafariDetailView,signup:new SignUpView},AppRouter=Parse.Router.extend({routes:{"":"home",login:"login",signup:"signup","forgot-password":"forgotPassword",safaris:"safaris","safari/:name":"safariDetail","photo/:id":"photoDetail",photos:"photoThumbnails",discover:"discover","location/:id":"locationDetail","*actions":"logout"},home:function(){var a=Parse.User.current();a?(changeLayout(!1,!0),views.dashboard.render(),userGeo.findLocation()):(changeLayout(!0,!1),views.home.render())},login:function(){changeLayout(!0,!1),views.login.render()},signup:function(){changeLayout(!0,!1),views.signup.render()},forgotPassword:function(){changeLayout(!0,!1),views.forgotPassword.render()},safaris:function(){changeLayout(!1,!1),views.safaris.render()},photoDetail:function(a){changeLayout(!1,!0),views.photoDetail.findPhoto(a)},photoThumbnails:function(){changeLayout(!1,!1),views.userPhoto.render()},safariDetail:function(a){changeLayout(!1,!0);var b=a,c=new Parse.Query(ScavengerHunt);c.equalTo("objectId",b),c.find({success:function(a){a.forEach(function(a){views.safariDetail.render(a)})},error:function(a){alert("Router/safariDetail Error: "+a.code+" "+a.message)}})},discover:function(){changeLayout(!1,!0),views.discover.render()},locationDetail:function(a){changeLayout(!1,!0),views.locationDetail.subscribedPhoto(a)},logout:function(){Parse.User.logOut(),window.router.navigate("login",{trigger:!0})}}),router=new AppRouter;Parse.history.start();